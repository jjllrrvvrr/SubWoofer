<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SubWoofer üê∂</title>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, sans-serif; 
            text-align: center; 
            padding: 20px; 
            background: #000; 
            color: #fff; 
            touch-action: manipulation;
        }
        
        /* Compteur */
        #timer { 
            font-size: 4rem; 
            font-weight: 700; 
            font-variant-numeric: tabular-nums; 
            color: #ff9f0a;
            margin-top: 10px;
        }
        .timer-label { font-size: 0.8rem; color: #666; text-transform: uppercase; margin-bottom: 20px;}

        /* Badges */
        #status-badge {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: bold;
            text-transform: uppercase;
            background: #333;
            color: #888;
            margin-bottom: 20px;
        }
        .status-rec { background: #ff3b30 !important; color: white !important; box-shadow: 0 0 15px #ff3b30; animation: pulse 1s infinite; }
        .status-wait { background: #30d158 !important; color: black !important; }
        .status-cooldown { background: #ff9f0a !important; color: black !important; }

        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        /* Canvas */
        .vis-container {
            position: relative;
            height: 150px;
            background: #1c1c1e;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid #333;
            margin-bottom: 10px;
        }
        canvas { width: 100%; height: 100%; }
        
        /* Ligne de seuil visuelle */
        #threshold-line {
            position: absolute;
            left: 0; right: 0;
            height: 2px;
            background-color: #0a84ff;
            bottom: 10%; 
            pointer-events: none;
            box-shadow: 0 0 8px #0a84ff;
            z-index: 10;
        }

        /* Slider Area */
        .slider-container {
            background: #2c2c2e;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
        }
        .slider-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            font-size: 0.9rem;
            color: #aaa;
        }
        .slider-value {
            color: #0a84ff;
            font-weight: bold;
            font-size: 1.2rem;
        }

        /* Custom Range Slider */
        input[type=range] { 
            width: 100%; 
            height: 40px; /* Zone tactile plus large */
            accent-color: #0a84ff; 
            cursor: pointer; 
        }

        /* Boutons */
        .controls { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; }
        .full-width { grid-column: span 2; }
        
        button { 
            font-size: 1.1rem; 
            padding: 20px; 
            border-radius: 16px; 
            border: none; 
            font-weight: 700; 
            color: white;
            cursor: pointer;
        }
        button:active { opacity: 0.8; transform: scale(0.98); }
        
        .btn-start { background: #30d158; color: #000; }
        .btn-pause { background: #ff9f0a; color: #000; }
        .btn-stop { background: #ff3b30; color: #fff; }
        .hidden { display: none; }

    </style>
</head>
<body>

    <div id="status-badge">Pr√™t</div>
    
    <div id="timer">00:00:00</div>
    <div class="timer-label">Dur√©e cumul√©e des aboiements</div>

    <!-- Zone visuelle -->
    <div class="vis-container">
        <canvas id="visualizer"></canvas>
        <div id="threshold-line"></div>
    </div>

    <!-- Zone r√©glage -->
    <div class="slider-container">
        <div class="slider-header">
            <span>Sensibilit√© (Seuil)</span>
            <span id="slider-val" class="slider-value">20</span>
        </div>
        <!-- Max 120 sur 255 : on zoome sur la moiti√© basse du spectre sonore -->
        <input type="range" id="slider" min="5" max="120" value="20" oninput="updateThresholdUI()">
        <div style="font-size: 0.7rem; color: #666; margin-top: 5px; text-align: left;">
            ‚ÑπÔ∏è R√©glez pour que la ligne bleue soit juste au-dessus du bruit de fond (barre verte).
        </div>
    </div>

    <div class="controls">
        <button id="btn-start" class="btn-start full-width" onclick="startApp()">‚ñ∂ D√âMARRER SURVEILLANCE</button>
        
        <button id="btn-pause" class="btn-pause hidden" onclick="togglePause()">‚è∏ PAUSE</button>
        <button id="btn-stop" class="btn-stop hidden" onclick="stopAndDownload()">‚èπ FINIR & T√âL√âCHARGER</button>
    </div>

    <script>
        // --- CONFIGURATION ---
        const SILENCE_DELAY = 2000; // 2 secondes de s√©curit√© apr√®s le bruit
        
        // --- VARIABLES ---
        let audioCtx, analyser, microphone, mediaRecorder;
        let masterChunks = []; 
        let currentSegment = []; 
        
        let isSystemActive = false;
        let isRecording = false;
        let isPausedManual = false;
        
        let lastNoiseTime = 0;
        let totalDuration = 0;
        let animationId;

        // UI Elements
        const canvas = document.getElementById('visualizer');
        const ctx = canvas.getContext('2d');
        const timerEl = document.getElementById('timer');
        const badge = document.getElementById('status-badge');
        const slider = document.getElementById('slider');
        const sliderValDisplay = document.getElementById('slider-val');
        const line = document.getElementById('threshold-line');
        
        // --- INITIALISATION ---
        async function startApp() {
            try {
                // Demande micro
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioCtx.createAnalyser();
                analyser.fftSize = 512; // R√©solution
                
                microphone = audioCtx.createMediaStreamSource(stream);
                microphone.connect(analyser);

                // Setup Recorder
                setupRecorder(stream);

                isSystemActive = true;
                updateUI('running');
                loop();

            } catch (e) {
                alert("Erreur Micro: " + e.message);
            }
        }

        function setupRecorder(stream) {
            // iOS pr√©f√®re mp4, Chrome pr√©f√®re webm
            let options = { mimeType: 'audio/webm' };
            if (!MediaRecorder.isTypeSupported('audio/webm')) {
                options = { mimeType: 'audio/mp4' }; 
            }
            window.globalStream = stream;
            window.recOptions = options;
        }

        function startSegment() {
            if (isRecording) return;
            
            // Nouveau segment
            mediaRecorder = new MediaRecorder(window.globalStream, window.recOptions);
            currentSegment = [];
            
            mediaRecorder.ondataavailable = e => {
                if (e.data.size > 0) currentSegment.push(e.data);
            };
            
            mediaRecorder.onstop = () => {
                // Sauvegarde du segment
                const blob = new Blob(currentSegment, { type: window.recOptions.mimeType });
                masterChunks.push(blob);
            };

            mediaRecorder.start();
            isRecording = true;
            badge.innerText = "ENREGISTREMENT...";
            badge.className = "status-rec";
        }

        function stopSegment() {
            if (!isRecording) return;
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
            }
            isRecording = false;
            badge.innerText = "En veille (√âcoute)";
            badge.className = "status-wait";
        }

        // --- BOUCLE PRINCIPALE ---
        function loop() {
            if (!isSystemActive) return;
            animationId = requestAnimationFrame(loop);

            if (isPausedManual) return;

            // 1. Analyse du volume
            const bufferLength = analyser.frequencyBinCount;
            const dataArray = new Uint8Array(bufferLength);
            analyser.getByteFrequencyData(dataArray);
            
            // Calculer la moyenne
            let sum = 0;
            for(let i=0; i<bufferLength; i++) sum += dataArray[i];
            let volume = sum / bufferLength;

            // 2. Seuil
            let threshold = parseInt(slider.value);
            
            // 3. Dessin
            drawVisualizer(volume, threshold);

            // 4. Logique
            let now = Date.now();

            if (volume > threshold) {
                // BRUIT
                lastNoiseTime = now;
                
                if (!isRecording) {
                    startSegment();
                }

                // Timer
                totalDuration += 16.66;
                timerEl.innerText = formatTime(totalDuration);
                
            } else {
                // SILENCE
                let timeSinceNoise = now - lastNoiseTime;

                if (timeSinceNoise < SILENCE_DELAY) {
                    // S√©curit√© (on continue d'enregistrer un peu)
                    if (isRecording) {
                        badge.innerText = "Fin d'aboiement...";
                        badge.className = "status-cooldown";
                        totalDuration += 16.66;
                        timerEl.innerText = formatTime(totalDuration);
                    }
                } else {
                    // Vrai silence -> STOP
                    if (isRecording) {
                        stopSegment();
                    }
                }
            }
        }

        // --- UI & OUTILS ---
        function updateThresholdUI() {
            let val = parseInt(slider.value);
            
            // Affiche la valeur
            sliderValDisplay.innerText = val;

            // Positionne la ligne bleue
            // Le volume va de 0 √† 255.
            // La ligne doit se placer proportionnellement √† la hauteur totale (255)
            let pct = (val / 255) * 100;
            
            // Inversion (bottom vs top) ou simple position bottom
            line.style.bottom = pct + "%";
        }

        function drawVisualizer(vol, thresh) {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Barre verte ou rouge
            // Hauteur calcul√©e sur max 255
            let h = (vol / 255) * canvas.height;
            
            // Couleur
            if (vol > thresh) {
                ctx.fillStyle = '#ff3b30'; // Rouge
            } else {
                ctx.fillStyle = '#30d158'; // Vert
            }
            
            ctx.fillRect(0, canvas.height - h, canvas.width, h);
        }

        function togglePause() {
            isPausedManual = !isPausedManual;
            let btn = document.getElementById('btn-pause');
            
            if (isPausedManual) {
                if (isRecording) stopSegment();
                badge.innerText = "PAUSE MANUELLE";
                badge.className = "";
                btn.innerText = "‚ñ∂ REPRENDRE";
                btn.style.background = "#30d158";
                btn.style.color = "white";
                ctx.clearRect(0,0,canvas.width, canvas.height);
            } else {
                badge.innerText = "En veille";
                badge.className = "status-wait";
                btn.innerText = "‚è∏ PAUSE";
                btn.style.background = "#ff9f0a";
                btn.style.color = "black";
            }
        }

        function stopAndDownload() {
            isSystemActive = false;
            cancelAnimationFrame(animationId);
            if (isRecording) stopSegment();

            // D√©lai pour laisser le dernier bout s'enregistrer
            setTimeout(() => {
                if (masterChunks.length === 0) {
                    alert("Aucun bruit d√©tect√©.");
                    location.reload();
                    return;
                }

                // Assemblage
                const finalBlob = new Blob(masterChunks, { type: window.recOptions.mimeType });
                const url = URL.createObjectURL(finalBlob);
                
                // T√©l√©chargement
                const a = document.createElement('a');
                a.href = url;
                let date = new Date();
                let timeStr = date.getHours() + "h" + date.getMinutes();
                a.download = `SubWoofer_${timeStr}_Total-${formatTime(totalDuration).replace(/:/g,'-')}.mp4`;
                
                document.body.appendChild(a);
                a.click();
                
                badge.innerText = "Sauvegard√© !";
                
                setTimeout(() => {
                    if(confirm("Fichier sauvegard√© ! Relancer ?")) location.reload();
                }, 1000);

            }, 500); 
        }

        function updateUI(state) {
            if (state === 'running') {
                document.getElementById('btn-start').classList.add('hidden');
                document.getElementById('btn-pause').classList.remove('hidden');
                document.getElementById('btn-stop').classList.remove('hidden');
                document.querySelector('.full-width').classList.remove('full-width');
            }
        }

        function formatTime(ms) {
            let s = Math.floor(ms / 1000);
            let m = Math.floor(s / 60);
            let h = Math.floor(m / 60);
            s = s % 60; m = m % 60;
            return `${pad(h)}:${pad(m)}:${pad(s)}`;
        }
        function pad(n) { return n.toString().padStart(2, '0'); }
        
        // Init
        updateThresholdUI();

    </script>
</body>
</html>
