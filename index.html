<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SubWoofer v7 üê∂</title>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            text-align: center; 
            padding: 20px; 
            background: #000; 
            color: #fff; 
            touch-action: manipulation;
            -webkit-user-select: none;
            user-select: none;
        }
        
        /* Compteur */
        #timer { 
            font-size: 3.5rem; 
            font-weight: 700; 
            font-variant-numeric: tabular-nums; 
            color: #ff9f0a;
            margin-top: 10px;
            text-shadow: 0 0 20px rgba(255, 159, 10, 0.3);
        }
        .timer-label { font-size: 0.75rem; color: #666; text-transform: uppercase; margin-bottom: 20px; letter-spacing: 1px;}

        /* Status Badge */
        #status-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 800;
            text-transform: uppercase;
            background: #2c2c2e;
            color: #888;
            margin-bottom: 15px;
            border: 1px solid #333;
        }
        .status-rec { background: #ff3b30 !important; color: white !important; box-shadow: 0 0 15px #ff3b30; animation: pulse 1s infinite; border-color: #ff3b30 !important;}
        .status-wait { background: #30d158 !important; color: #000 !important; border-color: #30d158 !important;}
        .status-pause { background: #ff9f0a !important; color: #000 !important; }

        @keyframes pulse { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.05); opacity: 0.8; } 100% { transform: scale(1); opacity: 1; } }

        /* Visualizer Box */
        .vis-container {
            position: relative;
            height: 120px;
            background: #1c1c1e;
            border-radius: 16px;
            overflow: hidden;
            border: 1px solid #333;
            margin-bottom: 15px;
            box-shadow: inset 0 0 20px #000;
        }
        canvas { width: 100%; height: 100%; }
        
        #threshold-line {
            position: absolute;
            left: 0; right: 0;
            height: 2px;
            background-color: #0a84ff;
            bottom: 20%; 
            pointer-events: none;
            box-shadow: 0 0 8px #0a84ff;
            z-index: 10;
            transition: bottom 0.1s ease-out;
        }

        /* Settings Card */
        .card {
            background: #1c1c1e;
            padding: 15px;
            border-radius: 16px;
            margin-bottom: 20px;
            border: 1px solid #333;
            text-align: left;
        }
        
        /* Filter Toggle Switch */
        .toggle-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #333;
        }
        .toggle-label { font-size: 0.9rem; font-weight: 600; }
        .toggle-sub { font-size: 0.7rem; color: #666; display: block; margin-top: 2px; }

        .switch-btn {
            background: #3a3a3c;
            color: #888;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 0.8rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .switch-btn.active {
            background: #0a84ff;
            color: white;
            box-shadow: 0 0 10px rgba(10, 132, 255, 0.4);
        }

        /* Slider */
        .slider-header { display: flex; justify-content: space-between; font-size: 0.8rem; color: #aaa; margin-bottom: 5px; }
        .slider-value { color: #0a84ff; font-weight: bold; }
        input[type=range] { width: 100%; height: 40px; accent-color: #0a84ff; cursor: pointer; }

        /* Main Buttons */
        .controls { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 10px; }
        .full-width { grid-column: span 2; }
        
        button.main-btn { 
            font-size: 1rem; padding: 18px; border-radius: 14px; border: none; 
            font-weight: 700; color: white; cursor: pointer; text-transform: uppercase;
            transition: transform 0.1s;
        }
        button.main-btn:active { transform: scale(0.96); }
        
        .btn-start { background: #30d158; color: #000; box-shadow: 0 4px 15px rgba(48, 209, 88, 0.3); }
        .btn-pause { background: #ff9f0a; color: #000; }
        .btn-stop { background: #ff3b30; color: #fff; }
        .hidden { display: none; }

    </style>
</head>
<body>

    <div id="status-badge">Pr√™t</div>
    
    <div id="timer">00:00:00</div>
    <div class="timer-label">Dur√©e cumul√©e des nuisances</div>

    <div class="vis-container">
        <canvas id="visualizer"></canvas>
        <div id="threshold-line"></div>
    </div>

    <div class="card">
        <!-- Bouton Filtre -->
        <div class="toggle-row">
            <div>
                <span class="toggle-label">üîç Filtre "Aboiements"</span>
                <span class="toggle-sub">Ignore voitures, vent & bruits sourds</span>
            </div>
            <button id="btn-filter" class="switch-btn active" onclick="toggleFilter()">ACTIV√â</button>
        </div>

        <!-- Slider Sensibilit√© -->
        <div class="slider-header">
            <span>Sensibilit√© (Seuil de d√©clenchement)</span>
            <span id="slider-val" class="slider-value">20</span>
        </div>
        <input type="range" id="slider" min="5" max="100" value="20" oninput="updateThresholdUI()">
    </div>

    <div class="controls">
        <button id="btn-start" class="main-btn btn-start full-width" onclick="startApp()">‚ñ∂ D√©marrer Surveillance</button>
        <button id="btn-pause" class="main-btn btn-pause hidden" onclick="togglePause()">‚è∏ Pause</button>
        <button id="btn-stop" class="main-btn btn-stop hidden" onclick="stopAndDownload()">‚èπ Finir</button>
    </div>

    <script>
        // --- CONFIGURATION ---
        const SILENCE_DELAY = 2000; // Temps de silence avant de couper (ms)
        const LOW_FREQ_CUT = 300;   // Coupe en dessous (Hz)
        const HIGH_FREQ_CUT = 3000; // Coupe au dessus (Hz)
        
        // --- VARIABLES ---
        let audioCtx, analyser, microphone, filterLow, filterHigh, mediaRecorder;
        let masterChunks = []; 
        let currentSegment = []; 
        
        let isSystemActive = false;
        let isRecording = false;
        let isPausedManual = false;
        let isFilterOn = true; // √âtat initial du filtre
        
        let lastNoiseTime = 0;
        let totalDuration = 0;
        let animationId;

        // --- DOM ELEMENTS ---
        const canvas = document.getElementById('visualizer');
        const ctx = canvas.getContext('2d');
        const timerEl = document.getElementById('timer');
        const badge = document.getElementById('status-badge');
        const slider = document.getElementById('slider');
        const sliderValDisplay = document.getElementById('slider-val');
        const line = document.getElementById('threshold-line');
        const filterBtn = document.getElementById('btn-filter');
        
        // 1. D√©marrage
        async function startApp() {
            try {
                // Demande micro
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                
                // Cr√©ation des noeuds audio
                analyser = audioCtx.createAnalyser();
                analyser.fftSize = 512;
                analyser.smoothingTimeConstant = 0.5; // Lisse un peu le visuel
                
                filterHigh = audioCtx.createBiquadFilter();
                filterHigh.type = "highpass";
                
                filterLow = audioCtx.createBiquadFilter();
                filterLow.type = "lowpass";

                // Application des r√©glages initiaux du filtre
                applyFilterSettings();

                microphone = audioCtx.createMediaStreamSource(stream);
                
                // Cha√Ænage : Micro -> FiltreHaut -> FiltreBas -> Analyseur
                microphone.connect(filterHigh);
                filterHigh.connect(filterLow);
                filterLow.connect(analyser);

                setupRecorder(stream); // On enregistre le son original (meilleure qualit√©)

                isSystemActive = true;
                updateUI('running');
                loop();

            } catch (e) {
                alert("Erreur d'acc√®s au micro : " + e.message);
            }
        }

        // 2. Gestion du Filtre
        function toggleFilter() {
            isFilterOn = !isFilterOn;
            
            // Mise √† jour visuelle du bouton
            if(isFilterOn) {
                filterBtn.innerText = "ACTIV√â";
                filterBtn.classList.add("active");
            } else {
                filterBtn.innerText = "D√âSACTIV√â";
                filterBtn.classList.remove("active");
            }

            // Application imm√©diate si l'audio tourne
            if(audioCtx) applyFilterSettings();
        }

        function applyFilterSettings() {
            if(!filterHigh || !filterLow) return;

            if (isFilterOn) {
                // Mode Filtr√© : On isole la fr√©quence de la voix/aboiement
                filterHigh.frequency.setValueAtTime(LOW_FREQ_CUT, audioCtx.currentTime);
                filterLow.frequency.setValueAtTime(HIGH_FREQ_CUT, audioCtx.currentTime);
            } else {
                // Mode Ouvert : On laisse tout passer
                // On met le passe-haut √† 0 (laisse passer les basses)
                filterHigh.frequency.setValueAtTime(0, audioCtx.currentTime); 
                // On met le passe-bas √† 22000 (laisse passer les aigus)
                filterLow.frequency.setValueAtTime(22000, audioCtx.currentTime);
            }
        }

        // 3. Enregistrement
        function setupRecorder(stream) {
            let options = { mimeType: 'audio/webm' };
            // Fallback pour Safari/iPhone qui pr√©f√®re mp4
            if (!MediaRecorder.isTypeSupported('audio/webm')) {
                options = { mimeType: 'audio/mp4' }; 
            }
            window.globalStream = stream;
            window.recOptions = options;
        }

        function startSegment() {
            if (isRecording) return;
            
            // Cr√©ation d'un nouveau fichier temporaire
            mediaRecorder = new MediaRecorder(window.globalStream, window.recOptions);
            currentSegment = [];
            
            mediaRecorder.ondataavailable = e => {
                if (e.data.size > 0) currentSegment.push(e.data);
            };
            
            mediaRecorder.onstop = () => {
                const blob = new Blob(currentSegment, { type: window.recOptions.mimeType });
                masterChunks.push(blob);
            };
            
            mediaRecorder.start();
            isRecording = true;
            badge.innerText = "BRUIT D√âTECT√â";
            badge.className = "status-rec";
        }

        function stopSegment() {
            if (!isRecording) return;
            if (mediaRecorder && mediaRecorder.state !== 'inactive') mediaRecorder.stop();
            isRecording = false;
            badge.innerText = "En veille (√âcoute)";
            badge.className = "status-wait";
        }

        // 4. Boucle principale (Analyse 60 fois par seconde)
        function loop() {
            if (!isSystemActive) return;
            animationId = requestAnimationFrame(loop);
            
            if (isPausedManual) return;

            const bufferLength = analyser.frequencyBinCount;
            const dataArray = new Uint8Array(bufferLength);
            analyser.getByteFrequencyData(dataArray);
            
            // Calcul du volume moyen instantan√©
            let sum = 0;
            for(let i=0; i<bufferLength; i++) sum += dataArray[i];
            let volume = sum / bufferLength;

            let threshold = parseInt(slider.value);
            
            // Dessin
            drawVisualizer(volume, threshold);

            // Logique de d√©clenchement
            let now = Date.now();
            
            if (volume > threshold) {
                // Si le volume d√©passe le seuil
                lastNoiseTime = now;
                if (!isRecording) startSegment();
                
                // Mise √† jour du chrono
                totalDuration += 16.66; // ~1 frame √† 60fps
                timerEl.innerText = formatTime(totalDuration);
            } else {
                // Si silence
                let timeSinceNoise = now - lastNoiseTime;
                
                if (timeSinceNoise < SILENCE_DELAY) {
                    // On attend encore un peu (d√©lai de gr√¢ce)
                    if (isRecording) {
                        badge.innerText = "Fin imminente...";
                        badge.className = "status-pause"; // Orange
                        // On compte ce temps de "blanc" dans la dur√©e totale pour la coh√©rence
                        totalDuration += 16.66;
                        timerEl.innerText = formatTime(totalDuration);
                    }
                } else {
                    // Silence confirm√© -> Couper
                    if (isRecording) stopSegment();
                }
            }
        }

        // 5. Interface Graphique
        function updateThresholdUI() {
            let val = parseInt(slider.value);
            sliderValDisplay.innerText = val;
            // On convertit la valeur (5-100) en position CSS %
            // On triche un peu pour que √ßa colle visuellement au canvas
            let pct = (val / 120) * 100; 
            line.style.bottom = pct + "%";
        }

        function drawVisualizer(vol, thresh) {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // On dessine le niveau de bruit
            // Facteur de zoom visuel pour mieux voir les sons faibles
            let barHeight = (vol / 120) * canvas.height; 
            
            if (vol > thresh) ctx.fillStyle = '#ff3b30'; // Rouge si d√©passement
            else ctx.fillStyle = '#30d158'; // Vert si OK
            
            // Effet de lissage basique
            ctx.fillRect(0, canvas.height - barHeight, canvas.width, barHeight);
        }

        function togglePause() {
            isPausedManual = !isPausedManual;
            let btn = document.getElementById('btn-pause');
            
            if (isPausedManual) {
                if (isRecording) stopSegment();
                badge.innerText = "PAUSE MANUELLE";
                badge.className = "status-pause";
                btn.innerText = "‚ñ∂ Reprendre";
                btn.style.background = "#30d158"; 
                btn.style.color = "white";
                ctx.clearRect(0,0,canvas.width, canvas.height); // Nettoyer canvas
            } else {
                badge.innerText = "En veille";
                badge.className = "status-wait";
                btn.innerText = "‚è∏ Pause";
                btn.style.background = "#ff9f0a"; 
                btn.style.color = "black";
            }
        }

        function stopAndDownload() {
            isSystemActive = false;
            cancelAnimationFrame(animationId);
            if (isRecording) stopSegment();

            // Petit d√©lai pour √™tre s√ªr que le dernier segment est sauvegard√©
            setTimeout(() => {
                if (masterChunks.length === 0) {
                    alert("Aucun bruit d√©tect√©, rien √† t√©l√©charger.");
                    location.reload();
                    return;
                }
                
                // Assemblage final
                const finalBlob = new Blob(masterChunks, { type: window.recOptions.mimeType });
                const url = URL.createObjectURL(finalBlob);
                
                // Cr√©ation lien t√©l√©chargement
                const a = document.createElement('a');
                a.href = url;
                
                let date = new Date();
                let timeStr = `${pad(date.getHours())}h${pad(date.getMinutes())}`;
                let durationStr = formatTime(totalDuration).replace(/:/g,'-');
                
                a.download = `Preuve_Bruit_${timeStr}_Duree-${durationStr}.mp4`;
                
                document.body.appendChild(a);
                a.click();
                
                badge.innerText = "Sauvegard√© !";
                
                setTimeout(() => { 
                    if(confirm("Fichier sauvegard√© ! Voulez-vous recommencer une session ?")) {
                        location.reload();
                    }
                }, 1000);

            }, 500); 
        }

        function updateUI(state) {
            if (state === 'running') {
                document.getElementById('btn-start').classList.add('hidden');
                document.getElementById('btn-pause').classList.remove('hidden');
                document.getElementById('btn-stop').classList.remove('hidden');
                document.querySelector('.full-width').classList.remove('full-width');
            }
        }

        function formatTime(ms) {
            let s = Math.floor(ms / 1000);
            let m = Math.floor(s / 60);
            let h = Math.floor(m / 60);
            s = s % 60; m = m % 60;
            return `${pad(h)}:${pad(m)}:${pad(s)}`;
        }
        function pad(n) { return n.toString().padStart(2, '0'); }
        
        // Init UI
        updateThresholdUI();
    </script>
</body>
</html>
